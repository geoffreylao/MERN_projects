"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("lodash"),t=require("events"),r=require("fs"),s=require("moment"),n=require("stream"),o=require("net"),a=require("reconnect-core"),i=require("@shelacek/ubjson"),l=require("iconv-lite"),c=require("path"),u=require("semver");function p(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function m(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var s=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,s.get?s:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var h=p(e),d=p(r),f=p(s),E=p(o),S=p(a),A=p(l),_=p(c),C=p(u);var N,T,R=Object.freeze({__proto__:null,getDeathDirection:function(e){if(e>10)return null;switch(e){case 0:return"down";case 1:return"left";case 2:return"right";default:return"up"}}});exports.Character=void 0,(N=exports.Character||(exports.Character={}))[N.CAPTAIN_FALCON=0]="CAPTAIN_FALCON",N[N.DONKEY_KONG=1]="DONKEY_KONG",N[N.FOX=2]="FOX",N[N.GAME_AND_WATCH=3]="GAME_AND_WATCH",N[N.KIRBY=4]="KIRBY",N[N.BOWSER=5]="BOWSER",N[N.LINK=6]="LINK",N[N.LUIGI=7]="LUIGI",N[N.MARIO=8]="MARIO",N[N.MARTH=9]="MARTH",N[N.MEWTWO=10]="MEWTWO",N[N.NESS=11]="NESS",N[N.PEACH=12]="PEACH",N[N.PIKACHU=13]="PIKACHU",N[N.ICE_CLIMBERS=14]="ICE_CLIMBERS",N[N.JIGGLYPUFF=15]="JIGGLYPUFF",N[N.SAMUS=16]="SAMUS",N[N.YOSHI=17]="YOSHI",N[N.ZELDA=18]="ZELDA",N[N.SHEIK=19]="SHEIK",N[N.FALCO=20]="FALCO",N[N.YOUNG_LINK=21]="YOUNG_LINK",N[N.DR_MARIO=22]="DR_MARIO",N[N.ROY=23]="ROY",N[N.PICHU=24]="PICHU",N[N.GANONDORF=25]="GANONDORF",exports.Stage=void 0,(T=exports.Stage||(exports.Stage={}))[T.FOUNTAIN_OF_DREAMS=2]="FOUNTAIN_OF_DREAMS",T[T.POKEMON_STADIUM=3]="POKEMON_STADIUM",T[T.PEACHS_CASTLE=4]="PEACHS_CASTLE",T[T.KONGO_JUNGLE=5]="KONGO_JUNGLE",T[T.BRINSTAR=6]="BRINSTAR",T[T.CORNERIA=7]="CORNERIA",T[T.YOSHIS_STORY=8]="YOSHIS_STORY",T[T.ONETT=9]="ONETT",T[T.MUTE_CITY=10]="MUTE_CITY",T[T.RAINBOW_CRUISE=11]="RAINBOW_CRUISE",T[T.JUNGLE_JAPES=12]="JUNGLE_JAPES",T[T.GREAT_BAY=13]="GREAT_BAY",T[T.HYRULE_TEMPLE=14]="HYRULE_TEMPLE",T[T.BRINSTAR_DEPTHS=15]="BRINSTAR_DEPTHS",T[T.YOSHIS_ISLAND=16]="YOSHIS_ISLAND",T[T.GREEN_GREENS=17]="GREEN_GREENS",T[T.FOURSIDE=18]="FOURSIDE",T[T.MUSHROOM_KINGDOM=19]="MUSHROOM_KINGDOM",T[T.MUSHROOM_KINGDOM_2=20]="MUSHROOM_KINGDOM_2",T[T.VENOM=22]="VENOM",T[T.POKE_FLOATS=23]="POKE_FLOATS",T[T.BIG_BLUE=24]="BIG_BLUE",T[T.ICICLE_MOUNTAIN=25]="ICICLE_MOUNTAIN",T[T.ICETOP=26]="ICETOP",T[T.FLAT_ZONE=27]="FLAT_ZONE",T[T.DREAMLAND=28]="DREAMLAND",T[T.YOSHIS_ISLAND_N64=29]="YOSHIS_ISLAND_N64",T[T.KONGO_JUNGLE_N64=30]="KONGO_JUNGLE_N64",T[T.BATTLEFIELD=31]="BATTLEFIELD",T[T.FINAL_DESTINATION=32]="FINAL_DESTINATION";const g={id:-1,name:"Unknown Character",shortName:"Unknown",colors:["Default"]},D=[{id:exports.Character.CAPTAIN_FALCON,name:"Captain Falcon",shortName:"Falcon",colors:["Default","Black","Red","White","Green","Blue"]},{id:exports.Character.DONKEY_KONG,name:"Donkey Kong",shortName:"DK",colors:["Default","Black","Red","Blue","Green"]},{id:exports.Character.FOX,name:"Fox",shortName:"Fox",colors:["Default","Red","Blue","Green"]},{id:exports.Character.GAME_AND_WATCH,name:"Mr. Game & Watch",shortName:"G&W",colors:["Default","Red","Blue","Green"]},{id:exports.Character.KIRBY,name:"Kirby",shortName:"Kirby",colors:["Default","Yellow","Blue","Red","Green","White"]},{id:exports.Character.BOWSER,name:"Bowser",shortName:"Bowser",colors:["Default","Red","Blue","Black"]},{id:exports.Character.LINK,name:"Link",shortName:"Link",colors:["Default","Red","Blue","Black","White"]},{id:exports.Character.LUIGI,name:"Luigi",shortName:"Luigi",colors:["Default","White","Blue","Red"]},{id:exports.Character.MARIO,name:"Mario",shortName:"Mario",colors:["Default","Yellow","Black","Blue","Green"]},{id:exports.Character.MARTH,name:"Marth",shortName:"Marth",colors:["Default","Red","Green","Black","White"]},{id:exports.Character.MEWTWO,name:"Mewtwo",shortName:"Mewtwo",colors:["Default","Red","Blue","Green"]},{id:exports.Character.NESS,name:"Ness",shortName:"Ness",colors:["Default","Yellow","Blue","Green"]},{id:exports.Character.PEACH,name:"Peach",shortName:"Peach",colors:["Default","Daisy","White","Blue","Green"]},{id:exports.Character.PIKACHU,name:"Pikachu",shortName:"Pikachu",colors:["Default","Red","Party Hat","Cowboy Hat"]},{id:exports.Character.ICE_CLIMBERS,name:"Ice Climbers",shortName:"ICs",colors:["Default","Green","Orange","Red"]},{id:exports.Character.JIGGLYPUFF,name:"Jigglypuff",shortName:"Puff",colors:["Default","Red","Blue","Headband","Crown"]},{id:exports.Character.SAMUS,name:"Samus",shortName:"Samus",colors:["Default","Pink","Black","Green","Purple"]},{id:exports.Character.YOSHI,name:"Yoshi",shortName:"Yoshi",colors:["Default","Red","Blue","Yellow","Pink","Cyan"]},{id:exports.Character.ZELDA,name:"Zelda",shortName:"Zelda",colors:["Default","Red","Blue","Green","White"]},{id:exports.Character.SHEIK,name:"Sheik",shortName:"Sheik",colors:["Default","Red","Blue","Green","White"]},{id:exports.Character.FALCO,name:"Falco",shortName:"Falco",colors:["Default","Red","Blue","Green"]},{id:exports.Character.YOUNG_LINK,name:"Young Link",shortName:"YLink",colors:["Default","Red","Blue","White","Black"]},{id:exports.Character.DR_MARIO,name:"Dr. Mario",shortName:"Doc",colors:["Default","Red","Blue","Green","Black"]},{id:exports.Character.ROY,name:"Roy",shortName:"Roy",colors:["Default","Red","Blue","Green","Yellow"]},{id:exports.Character.PICHU,name:"Pichu",shortName:"Pichu",colors:["Default","Red","Blue","Green"]},{id:exports.Character.GANONDORF,name:"Ganondorf",shortName:"Ganon",colors:["Default","Red","Blue","Green","Purple"]}];function I(e){return e<0||e>=D.length?g:D[e]}var x=Object.freeze({__proto__:null,UnknownCharacter:g,getAllCharacters:function(){return D},getCharacterInfo:I,getCharacterShortName:function(e){return I(e).shortName},getCharacterName:function(e){return I(e).name},getCharacterColorName:function(e,t){return I(e).colors[t]}});const O={id:-1,name:"Unknown Move",shortName:"unknown"},y={1:{id:1,name:"Miscellaneous",shortName:"misc"},2:{id:2,name:"Jab",shortName:"jab"},3:{id:3,name:"Jab",shortName:"jab"},4:{id:4,name:"Jab",shortName:"jab"},5:{id:5,name:"Rapid Jabs",shortName:"rapid-jabs"},6:{id:6,name:"Dash Attack",shortName:"dash"},7:{id:7,name:"Forward Tilt",shortName:"ftilt"},8:{id:8,name:"Up Tilt",shortName:"utilt"},9:{id:9,name:"Down Tilt",shortName:"dtilt"},10:{id:10,name:"Forward Smash",shortName:"fsmash"},11:{id:11,name:"Up Smash",shortName:"usmash"},12:{id:12,name:"Down Smash",shortName:"dsmash"},13:{id:13,name:"Neutral Air",shortName:"nair"},14:{id:14,name:"Forward Air",shortName:"fair"},15:{id:15,name:"Back Air",shortName:"bair"},16:{id:16,name:"Up Air",shortName:"uair"},17:{id:17,name:"Down Air",shortName:"dair"},18:{id:18,name:"Neutral B",shortName:"neutral-b"},19:{id:19,name:"Side B",shortName:"side-b"},20:{id:20,name:"Up B",shortName:"up-b"},21:{id:21,name:"Down B",shortName:"down-b"},50:{id:50,name:"Getup Attack",shortName:"getup"},51:{id:51,name:"Getup Attack (Slow)",shortName:"getup-slow"},52:{id:52,name:"Grab Pummel",shortName:"pummel"},53:{id:53,name:"Forward Throw",shortName:"fthrow"},54:{id:54,name:"Back Throw",shortName:"bthrow"},55:{id:55,name:"Up Throw",shortName:"uthrow"},56:{id:56,name:"Down Throw",shortName:"dthrow"},61:{id:61,name:"Edge Attack (Slow)",shortName:"edge-slow"},62:{id:62,name:"Edge Attack",shortName:"edge"}};function F(e){const t=y[e];return t||O}var M=Object.freeze({__proto__:null,UnknownMove:O,getMoveInfo:F,getMoveShortName:function(e){return F(e).shortName},getMoveName:function(e){return F(e).name}});const B={id:-1,name:"Unknown Stage"},L={[exports.Stage.FOUNTAIN_OF_DREAMS]:{id:exports.Stage.FOUNTAIN_OF_DREAMS,name:"Fountain of Dreams"},[exports.Stage.POKEMON_STADIUM]:{id:exports.Stage.POKEMON_STADIUM,name:"Pokémon Stadium"},[exports.Stage.PEACHS_CASTLE]:{id:exports.Stage.PEACHS_CASTLE,name:"Princess Peach's Castle"},[exports.Stage.KONGO_JUNGLE]:{id:exports.Stage.KONGO_JUNGLE,name:"Kongo Jungle"},[exports.Stage.BRINSTAR]:{id:exports.Stage.BRINSTAR,name:"Brinstar"},[exports.Stage.CORNERIA]:{id:exports.Stage.CORNERIA,name:"Corneria"},[exports.Stage.YOSHIS_STORY]:{id:exports.Stage.YOSHIS_STORY,name:"Yoshi's Story"},[exports.Stage.ONETT]:{id:exports.Stage.ONETT,name:"Onett"},[exports.Stage.MUTE_CITY]:{id:exports.Stage.MUTE_CITY,name:"Mute City"},[exports.Stage.RAINBOW_CRUISE]:{id:exports.Stage.RAINBOW_CRUISE,name:"Rainbow Cruise"},[exports.Stage.JUNGLE_JAPES]:{id:exports.Stage.JUNGLE_JAPES,name:"Jungle Japes"},[exports.Stage.GREAT_BAY]:{id:exports.Stage.GREAT_BAY,name:"Great Bay"},[exports.Stage.HYRULE_TEMPLE]:{id:exports.Stage.HYRULE_TEMPLE,name:"Hyrule Temple"},[exports.Stage.BRINSTAR_DEPTHS]:{id:exports.Stage.BRINSTAR_DEPTHS,name:"Brinstar Depths"},[exports.Stage.YOSHIS_ISLAND]:{id:exports.Stage.YOSHIS_ISLAND,name:"Yoshi's Island"},[exports.Stage.GREEN_GREENS]:{id:exports.Stage.GREEN_GREENS,name:"Green Greens"},[exports.Stage.FOURSIDE]:{id:exports.Stage.FOURSIDE,name:"Fourside"},[exports.Stage.MUSHROOM_KINGDOM]:{id:exports.Stage.MUSHROOM_KINGDOM,name:"Mushroom Kingdom I"},[exports.Stage.MUSHROOM_KINGDOM_2]:{id:exports.Stage.MUSHROOM_KINGDOM_2,name:"Mushroom Kingdom II"},[exports.Stage.VENOM]:{id:exports.Stage.VENOM,name:"Venom"},[exports.Stage.POKE_FLOATS]:{id:exports.Stage.POKE_FLOATS,name:"Poké Floats"},[exports.Stage.BIG_BLUE]:{id:exports.Stage.BIG_BLUE,name:"Big Blue"},[exports.Stage.ICICLE_MOUNTAIN]:{id:exports.Stage.ICICLE_MOUNTAIN,name:"Icicle Mountain"},[exports.Stage.ICETOP]:{id:exports.Stage.ICETOP,name:"Icetop"},[exports.Stage.FLAT_ZONE]:{id:exports.Stage.FLAT_ZONE,name:"Flat Zone"},[exports.Stage.DREAMLAND]:{id:exports.Stage.DREAMLAND,name:"Dream Land N64"},[exports.Stage.YOSHIS_ISLAND_N64]:{id:exports.Stage.YOSHIS_ISLAND_N64,name:"Yoshi's Island N64"},[exports.Stage.KONGO_JUNGLE_N64]:{id:exports.Stage.KONGO_JUNGLE_N64,name:"Kongo Jungle N64"},[exports.Stage.BATTLEFIELD]:{id:exports.Stage.BATTLEFIELD,name:"Battlefield"},[exports.Stage.FINAL_DESTINATION]:{id:exports.Stage.FINAL_DESTINATION,name:"Final Destination"}};function G(e){const t=L[e];return t||B}var P,U=Object.freeze({__proto__:null,UnknownStage:B,getStageInfo:G,getStageName:function(e){return G(e).name}});exports.State=void 0,(P=exports.State||(exports.State={}))[P.DAMAGE_START=75]="DAMAGE_START",P[P.DAMAGE_END=91]="DAMAGE_END",P[P.CAPTURE_START=223]="CAPTURE_START",P[P.CAPTURE_END=232]="CAPTURE_END",P[P.GUARD_START=178]="GUARD_START",P[P.GUARD_END=182]="GUARD_END",P[P.GROUNDED_CONTROL_START=14]="GROUNDED_CONTROL_START",P[P.GROUNDED_CONTROL_END=24]="GROUNDED_CONTROL_END",P[P.SQUAT_START=39]="SQUAT_START",P[P.SQUAT_END=41]="SQUAT_END",P[P.DOWN_START=183]="DOWN_START",P[P.DOWN_END=198]="DOWN_END",P[P.TECH_START=199]="TECH_START",P[P.TECH_END=204]="TECH_END",P[P.DYING_START=0]="DYING_START",P[P.DYING_END=10]="DYING_END",P[P.CONTROLLED_JUMP_START=24]="CONTROLLED_JUMP_START",P[P.CONTROLLED_JUMP_END=34]="CONTROLLED_JUMP_END",P[P.GROUND_ATTACK_START=44]="GROUND_ATTACK_START",P[P.GROUND_ATTACK_END=64]="GROUND_ATTACK_END",P[P.AERIAL_ATTACK_START=65]="AERIAL_ATTACK_START",P[P.AERIAL_ATTACK_END=74]="AERIAL_ATTACK_END",P[P.ROLL_FORWARD=233]="ROLL_FORWARD",P[P.ROLL_BACKWARD=234]="ROLL_BACKWARD",P[P.SPOT_DODGE=235]="SPOT_DODGE",P[P.AIR_DODGE=236]="AIR_DODGE",P[P.ACTION_WAIT=14]="ACTION_WAIT",P[P.ACTION_DASH=20]="ACTION_DASH",P[P.ACTION_KNEE_BEND=24]="ACTION_KNEE_BEND",P[P.GUARD_ON=178]="GUARD_ON",P[P.TECH_MISS_UP=183]="TECH_MISS_UP",P[P.TECH_MISS_DOWN=191]="TECH_MISS_DOWN",P[P.NEUTRAL_TECH=199]="NEUTRAL_TECH",P[P.FORWARD_TECH=200]="FORWARD_TECH",P[P.BACKWARD_TECH=201]="BACKWARD_TECH",P[P.WALL_TECH=202]="WALL_TECH",P[P.MISSED_WALL_TECH=247]="MISSED_WALL_TECH",P[P.DASH=20]="DASH",P[P.TURN=18]="TURN",P[P.LANDING_FALL_SPECIAL=43]="LANDING_FALL_SPECIAL",P[P.JUMP_FORWARD=25]="JUMP_FORWARD",P[P.JUMP_BACKWARD=26]="JUMP_BACKWARD",P[P.FALL_FORWARD=30]="FALL_FORWARD",P[P.FALL_BACKWARD=31]="FALL_BACKWARD",P[P.GRAB=212]="GRAB",P[P.GRAB_WAIT=216]="GRAB_WAIT",P[P.PUMMEL=217]="PUMMEL",P[P.CLIFF_CATCH=252]="CLIFF_CATCH",P[P.THROW_UP=221]="THROW_UP",P[P.THROW_FORWARD=219]="THROW_FORWARD",P[P.THROW_DOWN=222]="THROW_DOWN",P[P.THROW_BACK=220]="THROW_BACK",P[P.DAMAGE_FALL=38]="DAMAGE_FALL",P[P.BARREL_WAIT=293]="BARREL_WAIT",P[P.COMMAND_GRAB_RANGE1_START=266]="COMMAND_GRAB_RANGE1_START",P[P.COMMAND_GRAB_RANGE1_END=304]="COMMAND_GRAB_RANGE1_END",P[P.COMMAND_GRAB_RANGE2_START=327]="COMMAND_GRAB_RANGE2_START",P[P.COMMAND_GRAB_RANGE2_END=338]="COMMAND_GRAB_RANGE2_END",P[P.COMMAND_GRAB_RANGE3_START=375]="COMMAND_GRAB_RANGE3_START",P[P.COMMAND_GRAB_RANGE3_END=382]="COMMAND_GRAB_RANGE3_END";const v={PUNISH_RESET_FRAMES:45,RECOVERY_RESET_FRAMES:45,COMBO_STRING_RESET_FRAMES:45};function w(e){return e&&2===e.players.length?[{playerIndex:e.players[0].playerIndex,opponentIndex:e.players[1].playerIndex},{playerIndex:e.players[1].playerIndex,opponentIndex:e.players[0].playerIndex}]:[]}function k(e,t){return!(!e||!t)&&t.stocksRemaining-e.stocksRemaining>0}function H(e){const t=e>=exports.State.GROUNDED_CONTROL_START&&e<=exports.State.GROUNDED_CONTROL_END,r=e>=exports.State.SQUAT_START&&e<=exports.State.SQUAT_END,s=e>exports.State.GROUND_ATTACK_START&&e<=exports.State.GROUND_ATTACK_END,n=e===exports.State.GRAB;return t||r||s||n}function b(e){return e>=exports.State.TECH_START&&e<=exports.State.TECH_END}function W(e){return e>=exports.State.DOWN_START&&e<=exports.State.DOWN_END}function K(e){return e>=exports.State.DAMAGE_START&&e<=exports.State.DAMAGE_END||e===exports.State.DAMAGE_FALL}function Y(e){return e>=exports.State.CAPTURE_START&&e<=exports.State.CAPTURE_END}function J(e){return(e>=exports.State.COMMAND_GRAB_RANGE1_START&&e<=exports.State.COMMAND_GRAB_RANGE1_END||e>=exports.State.COMMAND_GRAB_RANGE2_START&&e<=exports.State.COMMAND_GRAB_RANGE2_END||e>=exports.State.COMMAND_GRAB_RANGE3_START&&e<=exports.State.COMMAND_GRAB_RANGE3_END)&&e!==exports.State.BARREL_WAIT}function z(e){return e>=exports.State.DYING_START&&e<=exports.State.DYING_END}function j(e,t){var r,s;return(null!==(r=e.percent)&&void 0!==r?r:0)-(null!==(s=t.percent)&&void 0!==s?s:0)}const $=[exports.State.DASH,exports.State.TURN,exports.State.DASH];class V{constructor(){this.playerPermutations=new Array,this.state=new Map}setup(e){this.state=new Map,this.playerPermutations=w(e),this.playerPermutations.forEach(e=>{const t={playerCounts:{playerIndex:e.playerIndex,wavedashCount:0,wavelandCount:0,airDodgeCount:0,dashDanceCount:0,spotDodgeCount:0,ledgegrabCount:0,rollCount:0,lCancelCount:{success:0,fail:0},grabCount:{success:0,fail:0},throwCount:{up:0,forward:0,back:0,down:0},groundTechCount:{backward:0,forward:0,neutral:0,fail:0},wallTechCount:{success:0,fail:0}},animations:[]};this.state.set(e,t)})}processFrame(e){this.playerPermutations.forEach(t=>{const r=this.state.get(t);r&&function(e,t,r){const s=r.players[t.playerIndex].post,n=(t,r)=>{r&&h.default.update(e.playerCounts,t,e=>e+1)},o=s.actionStateId;e.animations.push(o);const a=e.animations.slice(-3),i=a[a.length-2],l=o!==i,c=h.default.isEqual(a,$);n("dashDanceCount",c);const u=function(e,t){const r=Z(e),s=Z(t);return r&&!s}(o,i);n("rollCount",u);const p=function(e,t){const r=X(e),s=X(t);return r&&!s}(o,i);n("spotDodgeCount",p);const m=function(e,t){const r=q(e),s=q(t);return r&&!s}(o,i);n("airDodgeCount",m);const d=function(e,t){const r=Q(e),s=Q(t);return r&&!s}(o,i);n("ledgegrabCount",d);const f=function(e,t){return t===exports.State.GRAB&&e<=exports.State.GRAB_WAIT&&e>exports.State.GRAB}(o,i);n("grabCount.success",f);const E=function(e,t){return t===exports.State.GRAB&&(e>exports.State.GRAB_WAIT||e<exports.State.GRAB)}(o,i);if(n("grabCount.fail",E),n("throwCount.up",o===exports.State.THROW_UP&&l),n("throwCount.forward",o===exports.State.THROW_FORWARD&&l),n("throwCount.down",o===exports.State.THROW_DOWN&&l),n("throwCount.back",o===exports.State.THROW_BACK&&l),l){const e=(S=o)===exports.State.TECH_MISS_DOWN||S===exports.State.TECH_MISS_UP;n("groundTechCount.fail",e),n("groundTechCount.forward",o===exports.State.FORWARD_TECH),n("groundTechCount.neutral",o===exports.State.NEUTRAL_TECH),n("groundTechCount.backward",o===exports.State.BACKWARD_TECH),n("wallTechCount.success",o===exports.State.WALL_TECH),n("wallTechCount.fail",o===exports.State.MISSED_WALL_TECH)}var S;(function(e){return e>=exports.State.AERIAL_ATTACK_START&&e<=exports.State.AERIAL_ATTACK_END})(o)&&(n("lCancelCount.success",1===s.lCancelStatus),n("lCancelCount.fail",2===s.lCancelStatus));!function(e,t){const r=h.default.last(t),s=t[t.length-2],n=r===exports.State.LANDING_FALL_SPECIAL,o=function(e){if(e===exports.State.AIR_DODGE)return!0;const t=e>=exports.State.CONTROLLED_JUMP_START,r=e<=exports.State.CONTROLLED_JUMP_END;return t&&r}(s);if(!n||!o)return;const a=t.slice(-8),i=h.default.keyBy(a,e=>e);if(2===h.default.size(i)&&i[exports.State.AIR_DODGE])return;i[exports.State.AIR_DODGE]&&(e.airDodgeCount-=1);i[exports.State.ACTION_KNEE_BEND]?e.wavedashCount+=1:e.wavelandCount+=1}(e.playerCounts,e.animations)}(r,t,e)})}fetch(){return Array.from(this.state.values()).map(e=>e.playerCounts)}}function Z(e){return e===exports.State.ROLL_BACKWARD||e===exports.State.ROLL_FORWARD}function X(e){return e===exports.State.SPOT_DODGE}function q(e){return e===exports.State.AIR_DODGE}function Q(e){return e===exports.State.CLIFF_CATCH}var ee,te,re,se,ne;!function(e){e.COMBO_START="COMBO_START",e.COMBO_EXTEND="COMBO_EXTEND",e.COMBO_END="COMBO_END"}(ee||(ee={}));class oe extends t.EventEmitter{constructor(){super(...arguments),this.playerPermutations=new Array,this.state=new Map,this.combos=new Array,this.settings=null}setup(e){this.settings=e,this.state=new Map,this.combos=[],this.playerPermutations=w(e),this.playerPermutations.forEach(e=>{this.state.set(e,{combo:null,move:null,resetCounter:0,lastHitAnimation:null,event:null})})}processFrame(e,t){this.playerPermutations.forEach(r=>{const s=this.state.get(r);s&&(!function(e,t,r,s,n){var o,a,i,l;const c=s.frame,u=s.players[r.playerIndex].post,p=s.players[r.opponentIndex].post,m=c-1;let h=null,d=null;e[m]&&(h=e[m].players[r.playerIndex].post,d=e[m].players[r.opponentIndex].post);const f=p.actionStateId,E=K(f),S=Y(f),A=J(f),_=d?j(p,d):0,C=u.actionStateId!==t.lastHitAnimation,N=u.actionStateCounter,T=h?h.actionStateCounter:0,R=N<T;(C||R)&&(t.lastHitAnimation=null);if(E||S||A){let e=!1;t.combo||(t.combo={playerIndex:r.opponentIndex,startFrame:c,endFrame:null,startPercent:d&&null!==(o=d.percent)&&void 0!==o?o:0,currentPercent:null!==(a=p.percent)&&void 0!==a?a:0,endPercent:null,moves:[],didKill:!1,lastHitBy:r.playerIndex},n.push(t.combo),e=!0),_&&(null===t.lastHitAnimation&&(t.move={playerIndex:r.playerIndex,frame:c,moveId:u.lastAttackLanded,hitCount:0,damage:0},t.combo.moves.push(t.move),e||(t.event=ee.COMBO_EXTEND)),t.move&&(t.move.hitCount+=1,t.move.damage+=_),t.lastHitAnimation=h?h.actionStateId:null),e&&(t.event=ee.COMBO_START)}if(!t.combo)return;const g=b(f),D=W(f),I=d&&k(p,d),x=z(f);I||(t.combo.currentPercent=null!==(i=p.percent)&&void 0!==i?i:0);E||S||A||g||D||x?t.resetCounter=0:t.resetCounter+=1;let O=!1;I&&(t.combo.didKill=!0,O=!0);t.resetCounter>v.COMBO_STRING_RESET_FRAMES&&(O=!0);O&&(t.combo.endFrame=u.frame,t.combo.endPercent=d&&null!==(l=d.percent)&&void 0!==l?l:0,t.event=ee.COMBO_END,t.combo=null,t.move=null)}(t,s,r,e,this.combos),null!==s.event&&(this.emit(s.event,{combo:h.default.last(this.combos),settings:this.settings}),s.event=null))})}fetch(){return this.combos}}class ae extends t.EventEmitter{constructor(){super(),this.playerPermutations=new Array,this.conversions=new Array,this.state=new Map,this.settings=null,this.metadata={lastEndFrameByOppIdx:{}}}setup(e){this.playerPermutations=w(e),this.conversions=[],this.state=new Map,this.metadata={lastEndFrameByOppIdx:{}},this.settings=e,this.playerPermutations.forEach(e=>{this.state.set(e,{conversion:null,move:null,resetCounter:0,lastHitAnimation:null})})}processFrame(e,t){this.playerPermutations.forEach(r=>{const s=this.state.get(r);if(s){(function(e,t,r,s,n){var o,a,i,l;const c=s.frame,u=s.players[r.playerIndex].post,p=s.players[r.opponentIndex].post,m=c-1;let h=null,d=null;e[m]&&(h=e[m].players[r.playerIndex].post,d=e[m].players[r.opponentIndex].post);const f=p.actionStateId,E=K(f),S=Y(f),A=J(f),_=d?j(p,d):0,C=u.actionStateId!==t.lastHitAnimation,N=u.actionStateCounter,T=h?h.actionStateCounter:0,R=N<T;(C||R)&&(t.lastHitAnimation=null);(E||S||A)&&(t.conversion||(t.conversion={playerIndex:r.opponentIndex,lastHitBy:r.playerIndex,startFrame:c,endFrame:null,startPercent:d&&null!==(o=d.percent)&&void 0!==o?o:0,currentPercent:null!==(a=p.percent)&&void 0!==a?a:0,endPercent:null,moves:[],didKill:!1,openingType:"unknown"},n.push(t.conversion)),_&&(null===t.lastHitAnimation&&(t.move={playerIndex:r.playerIndex,frame:c,moveId:u.lastAttackLanded,hitCount:0,damage:0},t.conversion.moves.push(t.move)),t.move&&(t.move.hitCount+=1,t.move.damage+=_),t.lastHitAnimation=h?h.actionStateId:null));if(!t.conversion)return!1;const g=H(f),D=d&&k(p,d);D||(t.conversion.currentPercent=null!==(i=p.percent)&&void 0!==i?i:0);(E||S||A)&&(t.resetCounter=0);const I=0===t.resetCounter&&g,x=t.resetCounter>0;(I||x)&&(t.resetCounter+=1);let O=!1;D&&(t.conversion.didKill=!0,O=!0);t.resetCounter>v.PUNISH_RESET_FRAMES&&(O=!0);O&&(t.conversion.endFrame=u.frame,t.conversion.endPercent=d&&null!==(l=d.percent)&&void 0!==l?l:0,t.conversion=null,t.move=null);return O})(t,s,r,e,this.conversions)&&this.emit("CONVERSION",{combo:h.default.last(this.conversions),settings:this.settings})}})}fetch(){return this._populateConversionTypes(),this.conversions}_populateConversionTypes(){const e=h.default.filter(this.conversions,e=>"unknown"===e.openingType);h.default.chain(e).groupBy("startFrame").orderBy(e=>h.default.get(e,[0,"startFrame"])).value().forEach(e=>{const t=e.length>=2;e.forEach(e=>{if(this.metadata.lastEndFrameByOppIdx[e.playerIndex]=e.endFrame,t)return void(e.openingType="trade");const r=h.default.last(e.moves),s=this.metadata.lastEndFrameByOppIdx[r?r.playerIndex:e.playerIndex],n=s&&s>e.startFrame;e.openingType=n?"counter-attack":"neutral-win"})})}}exports.Command=void 0,(te=exports.Command||(exports.Command={}))[te.MESSAGE_SIZES=53]="MESSAGE_SIZES",te[te.GAME_START=54]="GAME_START",te[te.PRE_FRAME_UPDATE=55]="PRE_FRAME_UPDATE",te[te.POST_FRAME_UPDATE=56]="POST_FRAME_UPDATE",te[te.GAME_END=57]="GAME_END",te[te.ITEM_UPDATE=59]="ITEM_UPDATE",te[te.FRAME_BOOKEND=60]="FRAME_BOOKEND",exports.GameMode=void 0,(re=exports.GameMode||(exports.GameMode={}))[re.VS=2]="VS",re[re.ONLINE=8]="ONLINE",exports.Frames=void 0,(se=exports.Frames||(exports.Frames={}))[se.FIRST=-123]="FIRST",se[se.FIRST_PLAYABLE=-39]="FIRST_PLAYABLE",function(e){e[e.DZ=0]="DZ",e[e.NE=1]="NE",e[e.SE=2]="SE",e[e.SW=3]="SW",e[e.NW=4]="NW",e[e.N=5]="N",e[e.E=6]="E",e[e.S=7]="S",e[e.W=8]="W"}(ne||(ne={}));class ie{constructor(){this.state=new Map,this.playerPermutations=new Array}setup(e){this.state=new Map,this.playerPermutations=w(e),this.playerPermutations.forEach(e=>{const t={playerIndex:e.playerIndex,opponentIndex:e.opponentIndex,inputCount:0,joystickInputCount:0,cstickInputCount:0,buttonInputCount:0,triggerInputCount:0};this.state.set(e,t)})}processFrame(e,t){this.playerPermutations.forEach(r=>{const s=this.state.get(r);s&&function(e,t,r,s){const n=s.players[r.playerIndex].pre,o=n.frame,a=o-1,i=e[a]?e[a].players[r.playerIndex].pre:null;if(o<exports.Frames.FIRST_PLAYABLE||!i)return;const l=~i.physicalButtons,c=n.physicalButtons,u=function(e){let t,r=e;for(t=0;r;t+=1)r&=r-1;return t}(l&c&4095);t.inputCount+=u,t.buttonInputCount+=u;const p=le(i.joystickX,i.joystickY),m=le(n.joystickX,n.joystickY);p!==m&&m!==ne.DZ&&(t.inputCount+=1,t.joystickInputCount+=1);const h=le(i.cStickX,i.cStickY),d=le(n.cStickX,n.cStickY);h!==d&&d!==ne.DZ&&(t.inputCount+=1,t.cstickInputCount+=1);i.physicalLTrigger<.3&&n.physicalLTrigger>=.3&&(t.inputCount+=1,t.triggerInputCount+=1);i.physicalRTrigger<.3&&n.physicalRTrigger>=.3&&(t.inputCount+=1,t.triggerInputCount+=1)}(t,s,r,e)})}fetch(){return Array.from(this.state.values())}}function le(e,t){let r=ne.DZ;return e>=.2875&&t>=.2875?r=ne.NE:e>=.2875&&t<=-.2875?r=ne.SE:e<=-.2875&&t<=-.2875?r=ne.SW:e<=-.2875&&t>=.2875?r=ne.NW:t>=.2875?r=ne.N:e>=.2875?r=ne.E:t<=-.2875?r=ne.S:e<=-.2875&&(r=ne.W),r}function ce(e,t,r,s,n){const o=h.default.keyBy(t,"playerIndex"),a=s,i=h.default.groupBy(s,e=>{var t;return null===(t=e.moves[0])||void 0===t?void 0:t.playerIndex}),l=h.default.mapValues(i,e=>h.default.groupBy(e,"openingType")),c=n/3600;return e.players.map(t=>{const r=t.playerIndex,s=h.default.get(o,r)||{},n={buttons:h.default.get(s,"buttonInputCount"),triggers:h.default.get(s,"triggerInputCount"),cstick:h.default.get(s,"cstickInputCount"),joystick:h.default.get(s,"joystickInputCount"),total:h.default.get(s,"inputCount")};let i=0,u=0;const p=e.players.filter(s=>s.playerIndex!==r&&(!e.isTeams||s.teamId!==t.teamId)).map(e=>e.playerIndex);let m=0,d=0;return a.filter(e=>e.playerIndex!==r).forEach(e=>{i++,e.didKill&&e.lastHitBy===r&&(d+=1),e.moves.length>1&&e.moves[0].playerIndex===r&&u++,e.moves.forEach(e=>{e.playerIndex===r&&(m+=e.damage)})}),{playerIndex:r,inputCounts:n,conversionCount:i,totalDamage:m,killCount:d,successfulConversions:ue(u,i),inputsPerMinute:ue(n.total,c),digitalInputsPerMinute:ue(n.buttons,c),openingsPerKill:ue(i,d),damagePerOpening:ue(m,i),neutralWinRatio:pe(l,r,p,"neutral-win"),counterHitRatio:pe(l,r,p,"counter-attack"),beneficialTradeRatio:me(l,r,p)}})}function ue(e,t){return{count:e,total:t,ratio:t?e/t:null}}function pe(e,t,r,s){const n=h.default.get(e,[t,s])||[],o=h.default.flatten(r.map(t=>h.default.get(e,[t,s])||[]));return ue(n.length,n.length+o.length)}function me(e,t,r){const s=h.default.get(e,[t,"trade"])||[],n=h.default.flatten(r.map(t=>h.default.get(e,[t,"trade"])||[])),o=[];return h.default.zip(s,n).forEach(e=>{const t=h.default.first(e),r=h.default.last(e);if(t&&r){const e=t.currentPercent-t.startPercent,s=r.currentPercent-r.startPercent;(t.didKill&&!r.didKill||e>s)&&o.push(t)}}),ue(o.length,s.length)}const he={processOnTheFly:!1};class de{constructor(e){this.lastProcessedFrame=null,this.frames={},this.players=[],this.allComputers=new Array,this.options=Object.assign({},he,e)}setup(e){this.frames={},this.players=e.players.map(e=>e.playerIndex),this.allComputers.forEach(t=>t.setup(e))}register(...e){this.allComputers.push(...e)}process(){if(0===this.players.length)return;let e=null!==this.lastProcessedFrame?this.lastProcessedFrame+1:exports.Frames.FIRST;for(;this.frames[e];){const t=this.frames[e];if(!fe(this.players,t))return;this.allComputers.forEach(e=>e.processFrame(t,this.frames)),this.lastProcessedFrame=e,e++}}addFrame(e){this.frames[e.frame]=e,this.options.processOnTheFly&&this.process()}}function fe(e,t){for(const r of e){if(!h.default.get(t,["players",r,"post"]))return!1}return!0}class Ee{constructor(){this.state=new Map,this.playerPermutations=new Array,this.stocks=new Array}setup(e){this.state=new Map,this.playerPermutations=w(e),this.stocks=[],this.playerPermutations.forEach(e=>{this.state.set(e,{stock:null})})}processFrame(e,t){this.playerPermutations.forEach(r=>{const s=this.state.get(r);s&&function(e,t,r,s,n){var o,a;const i=s.players[r.playerIndex].post,l=i.frame,c=l-1,u=e[c]?e[c].players[r.playerIndex].post:null;if(t.stock)u&&k(i,u)?(t.stock.endFrame=i.frame,t.stock.endPercent=null!==(o=u.percent)&&void 0!==o?o:0,t.stock.deathAnimation=i.actionStateId,t.stock=null):t.stock.currentPercent=null!==(a=i.percent)&&void 0!==a?a:0;else{if(z(i.actionStateId))return;t.stock={playerIndex:r.playerIndex,startFrame:l,endFrame:null,startPercent:0,endPercent:null,currentPercent:0,count:i.stocksRemaining,deathAnimation:null},n.push(t.stock)}}(t,s,r,e,this.stocks)})}fetch(){return this.stocks}}var Se,Ae,_e,Ce;!function(e){e[e.HANDSHAKE=1]="HANDSHAKE",e[e.REPLAY=2]="REPLAY",e[e.KEEP_ALIVE=3]="KEEP_ALIVE"}(Se||(Se={}));class Ne{constructor(){this.receiveBuf=Buffer.from([]),this.messages=new Array}receive(e){for(this.receiveBuf=Buffer.concat([this.receiveBuf,e]);this.receiveBuf.length>=4;){const e=this.receiveBuf.readUInt32BE(0);if(this.receiveBuf.length<e+4)return;const t=this.receiveBuf.slice(4,e+4);this.messages.push(i.decode(t)),this.receiveBuf=this.receiveBuf.slice(e+4)}}getReceiveBuffer(){return this.receiveBuf}getMessages(){const e=this.messages;return this.messages=[],e}genHandshakeOut(e,t,r=!1){const s=Buffer.from([0,0,0,0]);s.writeUInt32BE(t,0);const n={type:Se.HANDSHAKE,payload:{cursor:e,clientToken:Uint8Array.from(s),isRealtime:r}},o=i.encode(n,{optimizeArrays:!0}),a=Buffer.concat([Buffer.from([0,0,0,0]),Buffer.from(o)]);return a.writeUInt32BE(o.byteLength,0),a}}exports.ConnectionEvent=void 0,(Ae=exports.ConnectionEvent||(exports.ConnectionEvent={})).CONNECT="connect",Ae.MESSAGE="message",Ae.HANDSHAKE="handshake",Ae.STATUS_CHANGE="statusChange",Ae.DATA="data",Ae.ERROR="error",exports.ConnectionStatus=void 0,(_e=exports.ConnectionStatus||(exports.ConnectionStatus={}))[_e.DISCONNECTED=0]="DISCONNECTED",_e[_e.CONNECTING=1]="CONNECTING",_e[_e.CONNECTED=2]="CONNECTED",_e[_e.RECONNECT_WAIT=3]="RECONNECT_WAIT",exports.Ports=void 0,(Ce=exports.Ports||(exports.Ports={}))[Ce.DEFAULT=51441]="DEFAULT",Ce[Ce.LEGACY=666]="LEGACY",Ce[Ce.RELAY_START=53741]="RELAY_START";var Te;!function(e){e.INITIAL="initial",e.LEGACY="legacy",e.NORMAL="normal"}(Te||(Te={}));const Re={consoleNick:"unknown",gameDataCursor:Uint8Array.from([0,0,0,0,0,0,0,0]),version:"",clientToken:0},ge={autoReconnect:!0};class De extends t.EventEmitter{constructor(e){super(),this.connectionStatus=exports.ConnectionStatus.DISCONNECTED,this.connDetails={...Re},this.client=null,this.connection=null,this.shouldReconnect=!1,this.ipAddress="0.0.0.0",this.port=exports.Ports.DEFAULT,this.options=Object.assign({},ge,e)}getStatus(){return this.connectionStatus}getSettings(){return{ipAddress:this.ipAddress,port:this.port}}getDetails(){return{...this.connDetails}}connect(e,t,r=2e4){this.ipAddress=e,this.port=t,this._connectOnPort(e,t,r)}_connectOnPort(e,t,r){const s=S.default(()=>E.default.connect({host:e,port:t,timeout:r}));this._setStatus(exports.ConnectionStatus.CONNECTING);const n=new Ne,o=s({initialDelay:2e3,maxDelay:1e4,strategy:"fibonacci",failAfter:1/0},s=>{var o;this.emit(exports.ConnectionEvent.CONNECT),this.shouldReconnect=this.options.autoReconnect,this.client=s;let a=Te.INITIAL;s.on("data",r=>{if(a===Te.INITIAL&&(a=this._getInitialCommState(r),console.log(`Connected to ${e}:${t} with type: ${a}`),this._setStatus(exports.ConnectionStatus.CONNECTED),console.log(r.toString("hex"))),a===Te.LEGACY)return void this._handleReplayData(r);try{n.receive(r)}catch(e){return console.error("Failed to process new data from server...",{error:e,prevDataBuf:n.getReceiveBuffer(),rcvData:r}),s.destroy(),void this.emit(exports.ConnectionEvent.ERROR,e)}const o=n.getMessages();try{o.forEach(e=>this._processMessage(e))}catch(e){console.error(e),s.destroy(),this.emit(exports.ConnectionEvent.ERROR,e)}}),s.on("timeout",()=>{console.warn(`Attempted connection to ${e}:${t} timed out after ${r}ms`),s.destroy()}),s.on("end",()=>{console.log("disconnect"),this.shouldReconnect||s.destroy()}),s.on("close",()=>{console.log("connection was closed")});const i=n.genHandshakeOut(this.connDetails.gameDataCursor,null!==(o=this.connDetails.clientToken)&&void 0!==o?o:0);s.write(i)}),a=()=>{this._setStatus(this.shouldReconnect?exports.ConnectionStatus.RECONNECT_WAIT:exports.ConnectionStatus.CONNECTING)};o.on("connect",a),o.on("reconnect",a),o.on("disconnect",()=>{this.shouldReconnect||(o.reconnect=!1,o.disconnect(),this._setStatus(exports.ConnectionStatus.DISCONNECTED))}),o.on("error",e=>{console.error(`Connection on port ${t} encountered an error.`,e)}),this.connection=o,o.connect(t)}disconnect(){this.connection&&(this.connection.reconnect=!1,this.connection.disconnect(),this.connection=null),this.client&&this.client.destroy()}_getInitialCommState(e){if(e.length<13)return Te.LEGACY;const t=Buffer.from([123,105,4,116,121,112,101,85,1]);return e.slice(4,13).equals(t)?Te.NORMAL:Te.LEGACY}_processMessage(e){switch(this.emit(exports.ConnectionEvent.MESSAGE,e),e.type){case Se.KEEP_ALIVE:const t=Buffer.from("HELO\0");this._handleReplayData(t);break;case Se.REPLAY:const r=Uint8Array.from(e.payload.pos),s=Buffer.compare(this.connDetails.gameDataCursor,r);if(!e.payload.forcePos&&0!==s)throw new Error(`Position of received data is incorrect. Expected: ${this.connDetails.gameDataCursor.toString()}, Received: ${r.toString()}`);e.payload.forcePos&&console.warn("Overflow occured in Nintendont, data has likely been skipped and replay corrupted. Expected, Received:",this.connDetails.gameDataCursor,r),this.connDetails.gameDataCursor=Uint8Array.from(e.payload.nextPos);const n=Uint8Array.from(e.payload.data);this._handleReplayData(n);break;case Se.HANDSHAKE:const{nick:o,nintendontVersion:a}=e.payload;o&&(this.connDetails.consoleNick=o);const i=Buffer.from(e.payload.clientToken);this.connDetails.clientToken=i.readUInt32BE(0),a&&(this.connDetails.version=a),this.connDetails.gameDataCursor=Uint8Array.from(e.payload.pos),this.emit(exports.ConnectionEvent.HANDSHAKE,this.connDetails)}}_handleReplayData(e){this.emit(exports.ConnectionEvent.DATA,e)}_setStatus(e){this.connectionStatus!==e&&(this.connectionStatus=e,this.emit(exports.ConnectionEvent.STATUS_CHANGE,this.connectionStatus))}}var Ie,xe,Oe;exports.DolphinMessageType=void 0,(Ie=exports.DolphinMessageType||(exports.DolphinMessageType={})).CONNECT_REPLY="connect_reply",Ie.GAME_EVENT="game_event",Ie.START_GAME="start_game",Ie.END_GAME="end_game";class ye extends t.EventEmitter{constructor(){super(),this.connectionStatus=exports.ConnectionStatus.DISCONNECTED,this.gameCursor=0,this.nickname="unknown",this.version="",this.peer=null,this.ipAddress="0.0.0.0",this.port=exports.Ports.DEFAULT}getStatus(){return this.connectionStatus}getSettings(){return{ipAddress:this.ipAddress,port:this.port}}getDetails(){return{consoleNick:this.nickname,gameDataCursor:this.gameCursor,version:this.version}}async connect(e,t){console.log(`Connecting to: ${e}:${t}`),this.ipAddress=e,this.port=t;const r=await Promise.resolve().then((function(){return m(require("enet"))})),s=r.createClient({peers:32,channels:3,down:0,up:0},e=>{e&&console.error(e)});this.peer=s.connect({address:this.ipAddress,port:this.port},3,1337,(e,t)=>{e?console.error(e):(t.ping(),this.emit(exports.ConnectionEvent.CONNECT),this._setStatus(exports.ConnectionStatus.CONNECTED))}),this.peer.on("connect",()=>{this.gameCursor=0;const e={type:"connect_request",cursor:this.gameCursor},t=new r.Packet(JSON.stringify(e),r.PACKET_FLAG.RELIABLE);this.peer.send(0,t)}),this.peer.on("message",e=>{const t=e.data();if(0===t.length)return;const r=t.toString("ascii"),s=JSON.parse(r),{dolphin_closed:n}=s;if(n)this.disconnect();else switch(this.emit(exports.ConnectionEvent.MESSAGE,s),s.type){case exports.DolphinMessageType.CONNECT_REPLY:this.connectionStatus=exports.ConnectionStatus.CONNECTED,this.gameCursor=s.cursor,this.nickname=s.nick,this.version=s.version,this.emit(exports.ConnectionEvent.HANDSHAKE,this.getDetails());break;case exports.DolphinMessageType.GAME_EVENT:{const{payload:e}=s;if(!e)return void this.disconnect();this._updateCursor(s,r);const t=Buffer.from(e,"base64");this._handleReplayData(t);break}case exports.DolphinMessageType.START_GAME:case exports.DolphinMessageType.END_GAME:this._updateCursor(s,r)}}),this.peer.on("disconnect",()=>{this.disconnect()}),this._setStatus(exports.ConnectionStatus.CONNECTING)}disconnect(){this.peer&&(this.peer.disconnect(),this.peer=null),this._setStatus(exports.ConnectionStatus.DISCONNECTED)}_handleReplayData(e){this.emit(exports.ConnectionEvent.DATA,e)}_setStatus(e){this.connectionStatus!==e&&(this.connectionStatus=e,this.emit(exports.ConnectionEvent.STATUS_CHANGE,this.connectionStatus))}_updateCursor(e,t){const{cursor:r,next_cursor:s}=e;if(this.gameCursor!==r){const e=new Error(`Unexpected game data cursor. Expected: ${this.gameCursor} but got: ${r}. Payload: ${t}`);console.warn(e),this.emit(exports.ConnectionEvent.ERROR,e)}this.gameCursor=s}}function Fe(e){const t=h.default.map(e,e=>{return(t=e.charCodeAt(0))>65280&&t<65375?t-65280+32:12288===t?32:8217===t?39:8221===t?34:t;var t});return String.fromCharCode(...t)}function Me(e,t,r,s,n){switch(e.source){case xe.FILE:return d.default.readSync(e.fileDescriptor,t,r,s,n);case xe.BUFFER:return e.buffer.copy(t,r,n,n+s);default:throw new Error("Source type not supported")}}function Be(e){switch(e.source){case xe.FILE:return d.default.fstatSync(e.fileDescriptor).size;case xe.BUFFER:return e.buffer.length;default:throw new Error("Source type not supported")}}function Le(e){const t=function(e){switch(e.source){case xe.FILE:if(!e.filePath)throw new Error("File source requires a file path");const t=d.default.openSync(e.filePath,"r");return{source:e.source,fileDescriptor:t};case xe.BUFFER:return{source:e.source,buffer:e.buffer};default:throw new Error("Source type not supported")}}(e),r=function(e){const t=new Uint8Array(1);if(Me(e,t,0,t.length,0),54===t[0])return 0;if(t[0]!=="{".charCodeAt(0))return 0;return 15}(t),s=function(e,t){const r=Be(e);if(0===t)return r;const s=new Uint8Array(4);Me(e,s,0,s.length,t-4);const n=s[0]<<24|s[1]<<16|s[2]<<8|s[3];if(n>0)return n;return r-t}(t,r),n=r+s+10;return{ref:t,rawDataPosition:r,rawDataLength:s,metadataPosition:n,metadataLength:function(e,t){return Be(e)-t-1}(t,n),messageSizes:function(e,t){const r={};if(0===t)return r[54]=320,r[55]=6,r[56]=70,r[57]=1,r;const s=new Uint8Array(2);if(Me(e,s,0,s.length,t),s[0]!==exports.Command.MESSAGE_SIZES)return{};const n=s[1];r[53]=n;const o=new Uint8Array(n-1);Me(e,o,0,o.length,t+2);for(let e=0;e<n-1;e+=3){const t=o[e];r[t]=o[e+1]<<8|o[e+2]}return r}(t,r)}}function Ge(e){switch(e.ref.source){case xe.FILE:d.default.closeSync(e.ref.fileDescriptor)}}function Pe(e,t){const r=new DataView(t.buffer);switch(e){case exports.Command.GAME_START:const e=e=>{const s=8*e,n=He(r,321+s);let o="None";n!==He(r,325+s)?o="Mixed":1===n?o="UCF":2===n&&(o="Dween");const a=353+16*e,i=t.slice(a,a+16),l=A.default.decode(i,"Shift_JIS").split("\0").shift(),c=l?Fe(l):"",u=421+31*e,p=t.slice(u,u+31),m=A.default.decode(p,"Shift_JIS").split("\0").shift(),h=m?Fe(m):"",d=545+10*e,f=t.slice(d,d+10),E=A.default.decode(f,"Shift_JIS").split("\0").shift(),S=E?Fe(E):"",_=36*e;return{playerIndex:e,port:e+1,characterId:We(r,101+_),characterColor:We(r,104+_),startStocks:We(r,103+_),type:We(r,102+_),teamId:We(r,110+_),controllerFix:o,nametag:c,displayName:h,connectCode:S}};return{slpVersion:`${We(r,1)}.${We(r,2)}.${We(r,3)}`,isTeams:Ke(r,13),isPAL:Ke(r,417),stageId:be(r,19),players:[0,1,2,3].map(e),scene:We(r,419),gameMode:We(r,420)};case exports.Command.PRE_FRAME_UPDATE:return{frame:we(r,1),playerIndex:We(r,5),isFollower:Ke(r,6),seed:He(r,7),actionStateId:be(r,11),positionX:ve(r,13),positionY:ve(r,17),facingDirection:ve(r,21),joystickX:ve(r,25),joystickY:ve(r,29),cStickX:ve(r,33),cStickY:ve(r,37),trigger:ve(r,41),buttons:He(r,45),physicalButtons:be(r,49),physicalLTrigger:ve(r,51),physicalRTrigger:ve(r,55),percent:ve(r,60)};case exports.Command.POST_FRAME_UPDATE:const s={airX:ve(r,53),y:ve(r,57),attackX:ve(r,61),attackY:ve(r,65),groundX:ve(r,69)};return{frame:we(r,1),playerIndex:We(r,5),isFollower:Ke(r,6),internalCharacterId:We(r,7),actionStateId:be(r,8),positionX:ve(r,10),positionY:ve(r,14),facingDirection:ve(r,18),percent:ve(r,22),shieldSize:ve(r,26),lastAttackLanded:We(r,30),currentComboCount:We(r,31),lastHitBy:We(r,32),stocksRemaining:We(r,33),actionStateCounter:ve(r,34),miscActionState:ve(r,43),isAirborne:Ke(r,47),lastGroundId:be(r,48),jumpsRemaining:We(r,50),lCancelStatus:We(r,51),hurtboxCollisionState:We(r,52),selfInducedSpeeds:s};case exports.Command.ITEM_UPDATE:return{frame:we(r,1),typeId:be(r,5),state:We(r,7),facingDirection:ve(r,8),velocityX:ve(r,12),velocityY:ve(r,16),positionX:ve(r,20),positionY:ve(r,24),damageTaken:be(r,28),expirationTimer:ve(r,30),spawnId:He(r,34),missileType:We(r,38),turnipFace:We(r,39),chargeShotLaunched:We(r,40),chargePower:We(r,41),owner:ke(r,42)};case exports.Command.FRAME_BOOKEND:return{frame:we(r,1),latestFinalizedFrame:we(r,5)};case exports.Command.GAME_END:return{gameEndMethod:We(r,1),lrasInitiatorIndex:ke(r,2)};default:return null}}function Ue(e,t,r){return t+r<=e.byteLength}function ve(e,t){return Ue(e,t,4)?e.getFloat32(t):null}function we(e,t){return Ue(e,t,4)?e.getInt32(t):null}function ke(e,t){return Ue(e,t,1)?e.getInt8(t):null}function He(e,t){return Ue(e,t,4)?e.getUint32(t):null}function be(e,t){return Ue(e,t,2)?e.getUint16(t):null}function We(e,t){return Ue(e,t,1)?e.getUint8(t):null}function Ke(e,t){return Ue(e,t,1)?!!e.getUint8(t):null}!function(e){e.BUFFER="buffer",e.FILE="file"}(xe||(xe={})),exports.SlpStreamMode=void 0,(Oe=exports.SlpStreamMode||(exports.SlpStreamMode={})).AUTO="AUTO",Oe.MANUAL="MANUAL";const Ye={suppressErrors:!1,mode:exports.SlpStreamMode.AUTO};var Je;exports.SlpStreamEvent=void 0,(Je=exports.SlpStreamEvent||(exports.SlpStreamEvent={})).RAW="slp-raw",Je.COMMAND="slp-command";class ze extends n.Writable{constructor(e,t){super(t),this.gameEnded=!1,this.payloadSizes=null,this.previousBuffer=Buffer.from([]),this.settings=Object.assign({},Ye,e)}restart(){this.gameEnded=!1,this.payloadSizes=null}_write(e,t,r){var s;if("buffer"!==t)throw new Error(`Unsupported stream encoding. Expected 'buffer' got '${t}'.`);const n=Uint8Array.from(Buffer.concat([this.previousBuffer,e]));this.previousBuffer=Buffer.from([]);const o=new DataView(n.buffer);let a=0;for(;a<n.length;){if("HELO\0"===Buffer.from(n.slice(a,a+5)).toString()){a+=5;continue}const e=o.getUint8(a);let t=0;this.payloadSizes&&(t=null!==(s=this.payloadSizes.get(e))&&void 0!==s?s:0);if(n.length-a<t+1){this.previousBuffer=n.slice(a);break}if(this.settings.mode===exports.SlpStreamMode.MANUAL&&this.gameEnded)break;a+=1;const r=n.slice(a),i=new DataView(n.buffer,a);let l=0;try{l=this._processCommand(e,r,i)}catch(e){if(!this.settings.suppressErrors)throw e;l=0}a+=l}r()}_writeCommand(e,t,r){const s=t.slice(0,r),n=Buffer.concat([Buffer.from([e]),s]);return this.emit(exports.SlpStreamEvent.RAW,{command:e,payload:n}),new Uint8Array(n)}_processCommand(e,t,r){var s;if(e===exports.Command.MESSAGE_SIZES){const s=r.getUint8(0);return this.payloadSizes=je(r),this._writeCommand(e,t,s),this.emit(exports.SlpStreamEvent.COMMAND,{command:e,payload:this.payloadSizes}),s}let n,o=0;this.payloadSizes&&(o=null!==(s=this.payloadSizes.get(e))&&void 0!==s?s:0);let a=null;if(o>0&&(n=this._writeCommand(e,t,o),a=Pe(e,n)),!a)return o;switch(e){case exports.Command.GAME_END:this.settings.mode===exports.SlpStreamMode.MANUAL&&(this.gameEnded=!0)}return this.emit(exports.SlpStreamEvent.COMMAND,{command:e,payload:a}),o}}const je=e=>{const t=new Map,r=e.getUint8(0);for(let s=1;s<r;s+=3){const r=e.getUint8(s),n=e.getUint16(s+1);t.set(r,n)}return t};class $e extends n.Writable{constructor(e,t,r){super(r),this.fileStream=null,this.rawDataLength=0,this.usesExternalStream=!1,this.filePath=e,this.metadata={consoleNickname:"unknown",startTime:f.default(),lastFrame:-124,players:{}},this.usesExternalStream=Boolean(t),this.slpStream=t||new ze({mode:exports.SlpStreamMode.MANUAL}),this._setupListeners(),this._initializeNewGame(this.filePath)}path(){return this.filePath}setMetadata(e){this.metadata=Object.assign({},this.metadata,e)}_write(e,t,r){if("buffer"!==t)throw new Error(`Unsupported stream encoding. Expected 'buffer' got '${t}'.`);this.fileStream&&this.fileStream.write(e),this.usesExternalStream||this.slpStream.write(e),this.rawDataLength+=e.length,r()}_onCommand(t){const{command:r,payload:s}=t;switch(r){case exports.Command.GAME_START:const{players:t}=s;e.forEach(t,(e,t)=>{3!==e.type&&(this.metadata.players[t]={characterUsage:{},names:{netplay:e.displayName,code:e.connectCode}})});break;case exports.Command.POST_FRAME_UPDATE:const{frame:r,playerIndex:n,isFollower:o,internalCharacterId:a}=s;if(o)break;this.metadata.lastFrame=r;const i=this.metadata.players[n],l=i.characterUsage,c=l[a]||0,u={...i,characterUsage:{...l,[a]:c+1}};this.metadata.players[n]=u}}_setupListeners(){const e=e=>{this._onCommand(e)};this.slpStream.on(exports.SlpStreamEvent.COMMAND,e),this.on("finish",()=>{const t=d.default.openSync(this.filePath,"r+");d.default.writeSync(t,Ze(this.rawDataLength),0,4,11),d.default.closeSync(t),this.slpStream.removeListener(exports.SlpStreamEvent.COMMAND,e),this.usesExternalStream||this.slpStream.end()})}_initializeNewGame(e){this.fileStream=d.default.createWriteStream(e,{encoding:"binary"});const t=Buffer.concat([Buffer.from("{U"),Buffer.from([3]),Buffer.from("raw[$U#l"),Buffer.from([0,0,0,0])]);this.fileStream.write(t)}_final(t){let r=Buffer.concat([Buffer.from("U"),Buffer.from([8]),Buffer.from("metadata{")]);const s=this.metadata.startTime.toISOString();r=Buffer.concat([r,Buffer.from("U"),Buffer.from([7]),Buffer.from("startAtSU"),Buffer.from([s.length]),Buffer.from(s)]);const n=this.metadata.lastFrame;r=Buffer.concat([r,Buffer.from("U"),Buffer.from([9]),Buffer.from("lastFramel"),Ve(n)]);const o=this.metadata.consoleNickname||"unknown";r=Buffer.concat([r,Buffer.from("U"),Buffer.from([11]),Buffer.from("consoleNickSU"),Buffer.from([o.length]),Buffer.from(o)]),r=Buffer.concat([r,Buffer.from("U"),Buffer.from([7]),Buffer.from("players{")]);const a=this.metadata.players;e.forEach(a,(t,s)=>{r=Buffer.concat([r,Buffer.from("U"),Buffer.from([s.length]),Buffer.from(s+"{")]),r=Buffer.concat([r,Buffer.from("U"),Buffer.from([10]),Buffer.from("characters{")]),e.forEach(t.characterUsage,(e,t)=>{r=Buffer.concat([r,Buffer.from("U"),Buffer.from([t.length]),Buffer.from(t+"l"),Ze(e)])}),r=Buffer.concat([r,Buffer.from("}")]),r=Buffer.concat([r,Buffer.from("U"),Buffer.from([5]),Buffer.from("names{")]),r=Buffer.concat([r,Buffer.from("U"),Buffer.from([7]),Buffer.from("netplaySU"),Buffer.from([t.names.netplay.length]),Buffer.from(""+t.names.netplay)]),r=Buffer.concat([r,Buffer.from("U"),Buffer.from([4]),Buffer.from("codeSU"),Buffer.from([t.names.code.length]),Buffer.from(""+t.names.code)]),r=Buffer.concat([r,Buffer.from("}}")])}),r=Buffer.concat([r,Buffer.from("}")]),r=Buffer.concat([r,Buffer.from("U"),Buffer.from([8]),Buffer.from("playedOnSU"),Buffer.from([7]),Buffer.from("network")]),r=Buffer.concat([r,Buffer.from("}}")]),this.fileStream&&this.fileStream.write(r,t)}}const Ve=e=>{const t=Buffer.alloc(4);return t.writeInt32BE(e,0),t},Ze=e=>{const t=Buffer.alloc(4);return t.writeUInt32BE(e,0),t};const Xe={outputFiles:!0,folderPath:".",consoleNickname:"unknown",newFilename:function(e,t){return _.default.join(e,`Game_${t.format("YYYYMMDD")}T${t.format("HHmmss")}.slp`)}};var qe;exports.SlpFileWriterEvent=void 0,(qe=exports.SlpFileWriterEvent||(exports.SlpFileWriterEvent={})).NEW_FILE="new-file",qe.FILE_COMPLETE="file-complete";var Qe;exports.SlpParserEvent=void 0,(Qe=exports.SlpParserEvent||(exports.SlpParserEvent={})).SETTINGS="settings",Qe.END="end",Qe.FRAME="frame",Qe.FINALIZED_FRAME="finalized-frame";const et={strict:!1};class tt extends t.EventEmitter{constructor(e){super(),this.frames={},this.settings=null,this.gameEnd=null,this.latestFrameIndex=null,this.settingsComplete=!1,this.lastFinalizedFrame=exports.Frames.FIRST-1,this.options=Object.assign({},et,e)}handleCommand(e,t){switch(e){case exports.Command.GAME_START:this._handleGameStart(t);break;case exports.Command.POST_FRAME_UPDATE:this._handlePostFrameUpdate(t),this._handleFrameUpdate(e,t);break;case exports.Command.PRE_FRAME_UPDATE:this._handleFrameUpdate(e,t);break;case exports.Command.ITEM_UPDATE:this._handleItemUpdate(t);break;case exports.Command.FRAME_BOOKEND:this._handleFrameBookend(t);break;case exports.Command.GAME_END:this._handleGameEnd(t)}}reset(){this.frames={},this.settings=null,this.gameEnd=null,this.latestFrameIndex=null,this.settingsComplete=!1,this.lastFinalizedFrame=exports.Frames.FIRST-1}getLatestFrameNumber(){var e;return null!==(e=this.latestFrameIndex)&&void 0!==e?e:exports.Frames.FIRST-1}getPlayableFrameCount(){return null===this.latestFrameIndex||this.latestFrameIndex<exports.Frames.FIRST_PLAYABLE?0:this.latestFrameIndex-exports.Frames.FIRST_PLAYABLE}getLatestFrame(){const e=this.getFrames(),t=null!==this.latestFrameIndex?this.latestFrameIndex:exports.Frames.FIRST,r=this.gameEnd?t:t-1;return h.default.get(e,r)||null}getSettings(){return this.settingsComplete?this.settings:null}getGameEnd(){return this.gameEnd}getFrames(){return this.frames}getFrame(e){return this.frames[e]||null}_handleGameEnd(e){null!==this.latestFrameIndex&&this.latestFrameIndex!==this.lastFinalizedFrame&&this._finalizeFrames(this.latestFrameIndex),e=e,this.gameEnd=e,this.emit(exports.SlpParserEvent.END,this.gameEnd)}_handleGameStart(e){this.settings=e;const t=e.players;this.settings.players=t.filter(e=>3!==e.type),e.slpVersion&&C.default.gte(e.slpVersion,"1.6.0")&&this._completeSettings()}_handlePostFrameUpdate(e){if(!this.settingsComplete){if(e.frame<=exports.Frames.FIRST){const t=e.playerIndex,r=h.default.keyBy(this.settings.players,"playerIndex");switch(e.internalCharacterId){case 7:r[t].characterId=19;break;case 19:r[t].characterId=18}}e.frame>exports.Frames.FIRST&&this._completeSettings()}}_handleFrameUpdate(e,t){t=t;const r=e===exports.Command.PRE_FRAME_UPDATE?"pre":"post",s=t.isFollower?"followers":"players",n=t.frame;this.latestFrameIndex=n,h.default.set(this.frames,[n,s,t.playerIndex,r],t),h.default.set(this.frames,[n,"frame"],n);const o=this.getSettings();!o||o.slpVersion&&!C.default.lte(o.slpVersion,"2.2.0")?h.default.set(this.frames,[n,"isTransferComplete"],!1):(this.emit(exports.SlpParserEvent.FRAME,this.frames[n]),this._finalizeFrames(n-1))}_handleItemUpdate(e){var t;const r=e.frame,s=null!==(t=this.frames[r].items)&&void 0!==t?t:[];s.push(e),h.default.set(this.frames,[r,"items"],s)}_handleFrameBookend(e){const t=e.latestFinalizedFrame,r=e.frame;h.default.set(this.frames,[r,"isTransferComplete"],!0),this.emit(exports.SlpParserEvent.FRAME,this.frames[r]);if(this.settings.gameMode===exports.GameMode.ONLINE&&t>=exports.Frames.FIRST){if(this.options.strict&&t<r-7)throw new Error("latestFinalizedFrame should be within 7 frames of "+r);this._finalizeFrames(t)}else this._finalizeFrames(r-7)}_finalizeFrames(e){for(;this.lastFinalizedFrame<e;){const t=this.lastFinalizedFrame+1,r=this.getFrame(t);if(this.options.strict)for(const s of this.settings.players){const n=r.players[s.playerIndex];if(this.settings.players.length>2&&!n)continue;const{pre:o,post:a}=n;if(!o||!a){throw new Error(`Could not finalize frame ${t} of ${e}: missing ${o?"pre":"post"}-frame update for player ${s.playerIndex}`)}}this.emit(exports.SlpParserEvent.FINALIZED_FRAME,r),this.lastFinalizedFrame=t}}_completeSettings(){this.settingsComplete||(this.settingsComplete=!0,this.emit(exports.SlpParserEvent.SETTINGS,this.settings))}}exports.ActionsComputer=V,exports.ComboComputer=oe,exports.ConsoleConnection=De,exports.ConversionComputer=ae,exports.DolphinConnection=ye,exports.InputComputer=ie,exports.MAX_ROLLBACK_FRAMES=7,exports.NETWORK_MESSAGE="HELO\0",exports.SlippiGame=class{constructor(e,t){if(this.metadata=null,this.finalStats=null,this.readPosition=null,this.actionsComputer=new V,this.conversionComputer=new ae,this.comboComputer=new oe,this.stockComputer=new Ee,this.inputComputer=new ie,h.default.isString(e))this.input={source:xe.FILE,filePath:e};else{if(!(e instanceof Buffer))throw new Error("Cannot create SlippiGame with input of that type");this.input={source:xe.BUFFER,buffer:e}}this.statsComputer=new de(t),this.statsComputer.register(this.actionsComputer,this.comboComputer,this.conversionComputer,this.inputComputer,this.stockComputer),this.parser=new tt,this.parser.on(exports.SlpParserEvent.SETTINGS,e=>{this.statsComputer.setup(e)}),this.parser.on(exports.SlpParserEvent.FINALIZED_FRAME,e=>{this.statsComputer.addFrame(e)})}_process(e=!1){if(null!==this.parser.getGameEnd())return;const t=Le(this.input);this.readPosition=function(e,t,r=null){const s=e.ref;let n=null!==r&&r>0?r:e.rawDataPosition;const o=e.rawDataPosition+e.rawDataLength,a=h.default.mapValues(e.messageSizes,e=>new Uint8Array(e+1)),i=new Uint8Array(1);for(;n<o;){Me(s,i,0,1,n);const e=i[0],r=a[e];if(void 0===r)return n;if(r.length>o-n)return n;Me(s,r,0,r.length,n);if(t(e,Pe(e,r)))break;n+=r.length}return n}(t,(t,r)=>!!r&&(this.parser.handleCommand(t,r),e&&null!==this.parser.getSettings()),this.readPosition),Ge(t)}getSettings(){return this._process(!0),this.parser.getSettings()}getLatestFrame(){return this._process(),this.parser.getLatestFrame()}getGameEnd(){return this._process(),this.parser.getGameEnd()}getFrames(){return this._process(),this.parser.getFrames()}getStats(){if(this.finalStats)return this.finalStats;this._process();const e=this.parser.getSettings();if(null===e)return null;this.statsComputer.process();const t=this.inputComputer.fetch(),r=this.stockComputer.fetch(),s=this.conversionComputer.fetch(),n=this.parser.getPlayableFrameCount(),o=ce(e,t,0,s,n),a={lastFrame:this.parser.getLatestFrameNumber(),playableFrameCount:n,stocks:r,conversions:s,combos:this.comboComputer.fetch(),actionCounts:this.actionsComputer.fetch(),overall:o,gameComplete:null!==this.parser.getGameEnd()};return null!==this.parser.getGameEnd()&&(this.finalStats=a),a}getMetadata(){if(this.metadata)return this.metadata;const e=Le(this.input);return this.metadata=function(e){if(e.metadataLength<=0)return null;const t=new Uint8Array(e.metadataLength);Me(e.ref,t,0,t.length,e.metadataPosition);let r=null;try{r=i.decode(t)}catch(e){}return r}(e),Ge(e),this.metadata}getFilePath(){var e;return this.input.source!==xe.FILE?null:null!==(e=this.input.filePath)&&void 0!==e?e:null}},exports.SlpFile=$e,exports.SlpFileWriter=class extends ze{constructor(e,t){super(e,t),this.currentFile=null,this.options=Object.assign({},Xe,e),this._setupListeners()}_writePayload(e){this.currentFile&&this.currentFile.write(e)}_setupListeners(){this.on(exports.SlpStreamEvent.RAW,e=>{const{command:t,payload:r}=e;switch(t){case exports.Command.MESSAGE_SIZES:this._handleNewGame(),this._writePayload(r);break;case exports.Command.GAME_END:this._writePayload(r),this._handleEndGame();break;default:this._writePayload(r)}})}getCurrentFilename(){return null!==this.currentFile?_.default.resolve(this.currentFile.path()):null}endCurrentFile(){this._handleEndGame()}updateSettings(e){this.options=Object.assign({},this.options,e)}_handleNewGame(){if(this.options.outputFiles){const e=this.options.newFilename(this.options.folderPath,f.default());this.currentFile=new $e(e,this),this.emit(exports.SlpFileWriterEvent.NEW_FILE,e)}}_handleEndGame(){this.currentFile&&(this.currentFile.setMetadata({consoleNickname:this.options.consoleNickname}),this.currentFile.end(),this.emit(exports.SlpFileWriterEvent.FILE_COMPLETE,this.currentFile.path()),this.currentFile=null)}},exports.SlpParser=tt,exports.SlpStream=ze,exports.Stats=de,exports.StockComputer=Ee,exports.Timers=v,exports.animations=R,exports.calcDamageTaken=j,exports.characters=x,exports.didLoseStock=k,exports.generateOverallStats=ce,exports.getSinglesPlayerPermutationsFromSettings=w,exports.isCommandGrabbed=J,exports.isDamaged=K,exports.isDead=z,exports.isDown=W,exports.isGrabbed=Y,exports.isInControl=H,exports.isTeching=b,exports.moves=M,exports.stages=U;
